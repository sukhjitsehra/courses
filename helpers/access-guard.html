<script>
(function () {
  const LOGIN_PATH = '/login/';
  const ACCESS_KEY = 'courseAccess';
  const SESSION_LIFETIME_MS = 12 * 60 * 60 * 1000; // 12 hours
  const LOCAL_DEV_LOGIN_BYPASS = true; // set to false to test the login gate locally

  function isLocalDevHost() {
    const hostname = window.location.hostname || '';
    return (
      hostname === 'localhost' ||
      hostname === '127.0.0.1' ||
      hostname === '[::1]' ||
      hostname.endsWith('.local')
    );
  }

  function shouldBypassLogin() {
    return Boolean(LOCAL_DEV_LOGIN_BYPASS) && isLocalDevHost();
  }

  function normalizePath(value) {
    if (!value || typeof value !== 'string') {
      return '/';
    }

    const trimmed = value.trim();
    if (!trimmed) {
      return '/';
    }

    if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
      try {
        const url = new URL(trimmed);
        return (url.pathname || '/').split('#')[0].split('?')[0] || '/';
      } catch (error) {
        return '/';
      }
    }

    const prefixed = trimmed.startsWith('/') ? trimmed : `/${trimmed}`;
    return prefixed.split('#')[0].split('?')[0] || '/';
  }

  function ensureTrailingSlash(value) {
    if (!value || value === '/') {
      return '/';
    }
    return value.endsWith('/') ? value : `${value}/`;
  }

  function normalizeAccessRoot(root) {
    if (!root) {
      return '/';
    }
    return ensureTrailingSlash(normalizePath(root));
  }

  function isPathWithinScope(pathname, accessRoot) {
    if (!accessRoot || accessRoot === '/') {
      return true;
    }

    const normalizedPath = normalizePath(pathname);
    const normalizedRoot = normalizeAccessRoot(accessRoot);

    if (normalizedPath === normalizedRoot.slice(0, -1)) {
      return true;
    }

    return normalizedPath.startsWith(normalizedRoot);
  }

  function isSameSiteHref(href) {
    if (!href) {
      return false;
    }

    if (href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('#')) {
      return false;
    }

    try {
      const url = new URL(href, window.location.origin);
      return url.origin === window.location.origin;
    } catch (error) {
      return false;
    }
  }

  function ensureInternalLinksStayInTab() {
    const anchors = window.document.querySelectorAll('a[target]');
    anchors.forEach((anchor) => {
      const href = anchor.getAttribute('href');
      if (isSameSiteHref(href)) {
        anchor.removeAttribute('target');
      }
    });
  }

  window.addEventListener('DOMContentLoaded', ensureInternalLinksStayInTab);

  const path = normalizePath(window.location.pathname);
  const isLoginPage = path === '/login' || path === '/login/' || path.startsWith('/login/');
  const isLocalBypass = shouldBypassLogin();

  if (isLoginPage || isLocalBypass) {
    return;
  }

  let shouldRedirect = false;
  try {
    const raw = sessionStorage.getItem(ACCESS_KEY);
    if (!raw) {
      shouldRedirect = true;
    } else {
      const parsed = JSON.parse(raw);
      const accessRoot = normalizeAccessRoot(parsed.accessRoot);
      const isExpired = !parsed.grantedAt || Date.now() - parsed.grantedAt > SESSION_LIFETIME_MS;
      const outOfScope = !isPathWithinScope(path, accessRoot);
      if (isExpired) {
        sessionStorage.removeItem(ACCESS_KEY);
        shouldRedirect = true;
      } else if (outOfScope) {
        shouldRedirect = true;
      }
    }
  } catch (error) {
    console.warn('Unable to read course access token', error);
    shouldRedirect = true;
  }

  if (shouldRedirect) {
    const current = encodeURIComponent(path + window.location.search + window.location.hash);
    const target = `${LOGIN_PATH}?next=${current}`;
    window.location.replace(target);
  }
})();
</script>
<noscript>
  <div style="padding:1rem;background:#fee2e2;border-left:4px solid #b91c1c;">
    JavaScript is required to access the course portal. Please enable it and reload this page.
  </div>
</noscript>
